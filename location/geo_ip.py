#!/usr/bin/python

import pygeoip
import dpkt
import socket
import optparse

src_ip = []
dst_ip = []
gi = pygeoip.GeoIP('/opt/GeoLiteCity.dat')

def getip(pcap):
	for (ts, buf) in pcap:
		try:
			eth = dpkt.ethernet.Ethernet(buf)
			ip = eth.data
			src = socket.inet_ntoa(ip.src)
			dst = socket.inet_ntoa(ip.dst)
			src_ip.append(src)
			dst_ip.append(dst)
		except:
			pass

def retGeo(ip):
	try:
		rec = gi.record_by_name(ip)
		city = rec['city']
		country = rec['country_code3']	
		geoLoc = city + "," + country
		return geoLoc
	except:
		return

def main():
	parser = optparse.OptionParser("usage%prog -p <pcap file>")
	parser.add_option("-p", dest='pcapFile', type='string', help="specify pcap filename")
	(options, args) = parser.parse_args()

	if options.pcapFile == None:
		print parser.usage
		exit(0)

	pcapFile = options.pcapFile
	f = open(pcapFile)
	pcap = dpkt.pcap.Reader(f)
	getip(pcap)
	print src_ip
	print dst_ip
	for ip in dst_ip:
		print "[+]" + ip + ": " + str(retGeo(ip))

if __name__ == "__main__":
	main()


