#!/usr/bin/python
# -*- coding: utf-8 -*

import socket
import StringIO
import pycurl
import re
import struct 
import fcntl 
import random
import string

##
def get_mac(ifname):
	s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
	info = fcntl.ioctl(s.fileno(), 0x8927,  struct.pack('256s', ifname[:15]))
	return ':'.join(['%02x' % ord(char) for char in info[18:24]])

def get_MAC(ifname):
	s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
	info = fcntl.ioctl(s.fileno(), 0x8927,  struct.pack('256s', ifname[:15]))
	mac = ''.join(['%02x' % ord(char) for char in info[18:24]])
	return mac.upper()

def get_ip(ifname): 
	s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM) 
	return socket.inet_ntoa(fcntl.ioctl(s.fileno(), 0X8915, struct.pack('256s', ethname[:15]))[20:24]) 

def perform_url(c):
	c.setopt(pycurl.USERAGENT, "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0")
	c.setopt(pycurl.FOLLOWLOCATION, 3)
	c.perform()


def main():
	c = pycurl.Curl()
	buf = StringIO.StringIO()  #set http respone body buf
	head = StringIO.StringIO() #set http respone head buf
	c.setopt(pycurl.WRITEFUNCTION, buf.write)
	c.setopt(pycurl.HEADERFUNCTION, head.write)

	#any true address
	url1 = "http://www.qq.com"
	c.setopt(pycurl.URL, url1)
	c.setopt(pycurl.USERAGENT, "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:45.0) Gecko/20100101 Firefox/45.0")
	#设置重定向3次，第一次为nexturl标签，第二次为location字段
	c.setopt(pycurl.FOLLOWLOCATION, 3)
	c.setopt(pycurl.MAXREDIRS, 3)
	c.perform()


	head.read()
	#print buf.buf
	#not cover "&"
	#从 第二次返回的location 字段中读出一些信息， ?(?=(&|$))是匹配以&结尾的字符串，不包括&
	dev_id = re.search("dev_id=.*?(?=(&|$))", head.buf).group(0)[7:]
	print dev_id
	ac_name = re.search("ac_name=.*?(?=(&|$))", head.buf).group(0)[8:]
	print ac_name
	user_ip = re.search("user_ip=.*?(?=(&|$))", head.buf).group(0)[8:]
	print user_ip
	user_mac = re.search("user_mac=.*?(?=(&|$))", head.buf).group(0)[9:]
	print user_mac

	#电话号码
	mobile = "18509254706"
	auth_type = "mobile"
	ip = user_ip# get_ip("wlan0")
	mac = user_mac#get_MAC("wlan0")
	auth_code = "123456"
	#这个是jQuery随机生成的函数名，发现用这个也成，规则 jQuery + 20数字 + _ + 13数字
	jQuery_func = "jQuery111205590540263360831_1460864420730"

	#提交手机号
	url2 = "http://auth.51awifi.com/api/users/is_blacklist?callback="+ jQuery_func +"&mobile=" + mobile +  "&dev_id=" + dev_id + "&_=1461471237119"

	c.setopt(pycurl.URL, url2)
	c.perform()

	#buf.read()
	#print buf.buf

	#请求发送验证码，之后手机会收到验证码，感觉可以向随意指定手机发验证码，bug
	url3 = "http://auth.51awifi.com/bas/sendcode.htm?getResultRequest="+ jQuery_func +"&auth_id=" + mobile + "&auth_type=" + auth_type + "&dev_id=" + dev_id + "&ter_mac=" + mac + "&ac_name=" + ac_name + "&_=1461471237120"

	c.setopt(pycurl.URL, url3)
	c.perform()

	#buf.read()
	#print buf.buf

	#输入刚才收到的验证码
	auth_code = raw_input("input auth code:")
	print "[+] " + str(auth_code)
	#提交验证吗
	url4 = "http://auth.51awifi.com/bas/login.htm?getResultRequest="+ jQuery_func +"&auth_id=" + mobile +  "&auth_code=" + auth_code + "&auth_type=" + auth_type + "&dev_id=" + dev_id + "&mac=" + mac + "&site_id=94687&dev_mac=&user_ip=" + ip + "&ac_name=" + ac_name + "&from=aci&browser_type=Firefox&terminal_type=Windows&is_authed=false&_=1461471237123"

	c.setopt(pycurl.URL, url4)
	c.perform()

	#完成验证
	url5 = "http://pub.51awifi.com/api/users/auth_finish?callback=" + jQuery_func + "&auth_id=" + mobile + "&dev_id=" + dev_id + "&user_mac=" + mac + "&site_id=94687&user_ip=" + ip +  "&browser=Firefox&os_brand=Windows&_=1461471237124"

	c.setopt(pycurl.URL, url5)
	c.perform()


if __name__ == "__main__":
	main()




